# KIMI-IDA Project Documentation

## Project Overview

**kimi-ida** is a Rust-based plugin for IDA Pro that integrates the Moonshot AI (KIMI) API to provide automated reverse engineering analysis. The plugin decompiles functions using Hex-Rays, sends the pseudocode to the KIMI AI for analysis, and applies the results (renamed variables, comments, function names) back to the IDA database.

### Key Features
- **Single Function Analysis**: Analyze the current function under the cursor (Ctrl+Shift+K)
- **Batch Analysis**: Analyze all functions in the binary automatically
- **Smart Variable Renaming**: AI-suggested meaningful variable names
- **Automatic Commenting**: Adds explanatory comments to complex code sections
- **Function Renaming**: Suggests descriptive function names based on behavior analysis

## Technology Stack

- **Language**: Rust (Edition 2024, requires nightly toolchain)
- **Target Platform**: Windows x64 (MSVC toolchain)
- **Build Tool**: Cargo with custom `build.rs`
- **External Dependencies**:
  - IDA Pro 9.0+ with Hex-Rays decompiler
  - Moonshot AI API key

### Rust Dependencies
```toml
[dependencies]
textwrap = "0.16.2"        # Text formatting for comments
reqwest = "0.13.1"         # HTTP client for KIMI API
serde_json = "1.0"         # JSON serialization
serde = { version = "1.0", features = ["derive"] }
rayon = "1.11.0"           # Data parallelism for batch processing
spin = "0.10.0"            # Lock-free synchronization

[build-dependencies]
bindgen = "0.72.1"         # FFI bindings generation from IDA SDK headers
```

## Project Structure

```
kimi-ida/
├── Cargo.toml          # Rust project configuration
├── Cargo.lock          # Dependency lock file
├── build.rs            # Build script for bindgen FFI generation
├── LICENSE             # MIT License
├── ida.lib             # IDA SDK import library (Windows x64)
├── ida-sdk/            # IDA SDK headers (git submodule)
│   └── src/include/    # C++ headers (pro.h, ida.hpp, hexrays.hpp, etc.)
├── bindgen/            # Generated FFI bindings
│   └── bindings.rs     # Auto-generated by bindgen (cached)
├── src/                # Source code
│   ├── lib.rs          # Plugin entry point and lifecycle
│   ├── ida.rs          # IDA SDK FFI bindings and wrappers (~2000 lines)
│   ├── kimi.rs         # Moonshot AI API client
│   ├── context.rs      # Plugin state management
│   ├── analysis.rs     # Core analysis logic and AI prompting
│   ├── actions.rs      # IDA UI action handlers
│   ├── ctree_visitor.rs # Hex-Rays ctree visitor implementation
│   ├── strvec.rs       # Hex-Rays decompiler output handling
│   └── prelude.rs      # Common imports and macros
└── target/             # Build output (gitignored)
```

### Module Descriptions

| Module | Purpose |
|--------|---------|
| `lib.rs` | Plugin lifecycle: `ida_init()`, `ida_run()`, `ida_term()`. Exports `PLUGIN` struct for IDA. |
| `ida.rs` | Comprehensive FFI bindings to IDA SDK including: functions, xrefs, types, decompiler APIs |
| `kimi.rs` | HTTP client for Moonshot AI API (`api.kimi.com/coding/v1`) |
| `context.rs` | Global state: `Context` (function database), `AnalyzedFunction` (AI results) |
| `analysis.rs` | Collects pseudocode, data references, builds prompts, parses AI responses |
| `actions.rs` | Registers UI actions: "Analyze Function", "Analyze All Functions" |
| `ctree_visitor.rs` | Hex-Rays ctree visitor for collecting instruction-level information |
| `strvec.rs` | Handles `strvec_t` / `simpleline_t` for decompiler output |
| `prelude.rs` | Common imports, custom `println!` and `dbg!` macros that output to IDA console |

## Build Instructions

### Prerequisites

1. **Rust nightly toolchain** (required for unstable features):
   ```bash
   rustup default nightly
   rustup target add x86_64-pc-windows-msvc
   rustup component add rust-src  # Required for build-std
   ```

2. **IDA SDK** (automatically cloned as submodule or set via env var):
   ```bash
   git submodule update --init --recursive
   ```

3. **Environment Variable**:
   ```bash
   set KIMI_API_KEY=sk-kimi-your-api-key-here
   ```

### Build Commands

```bash
# Debug build
cargo build

# Release build (optimized, recommended)
cargo build --release

# The plugin DLL will be at:
# target/release/kimi_ida.dll
```

### Build Configuration

The `build.rs` script:
1. Locates IDA SDK via `IDASDK` env var or defaults to `./ida-sdk`
2. Runs `bindgen` on key headers (`pro.h`, `ida.hpp`, `hexrays.hpp`, etc.)
3. Generates `bindgen/bindings.rs` (cached after first build)
4. Links against `ida.lib`

Key bindgen settings:
- Target: `x86_64-pc-windows-msvc`
- Standard: C++17
- Defines: `__IDP__`, `__EA64__`, `__NT__`, `__X64__`
- Blocked types: `std::.*`, `qlist`, `.*iterator.*` (problematic STL types)

### Release Profile Optimizations

```toml
[profile.release]
opt-level = 3          # Maximum optimization
codegen-units = 1      # Single codegen unit for better LTO
lto = true             # Link-time optimization
panic = "abort"        # Smaller binary, no unwinding
overflow-checks = false
rustflags = [
  "-Ctarget-feature=+fma,+avx,+avx2",
  "-Ccontrol-flow-guard=off",
]
```

## Installation and Usage

### Deploy to IDA Pro

1. Copy `target/release/kimi_ida.dll` to IDA's plugins directory:
   ```
   C:\Program Files\IDA Pro 9.x\plugins\kimi_ida.dll
   ```

2. Ensure `ida.lib` is in the project root for linking

3. Set environment variable before launching IDA:
   ```bash
   set KIMI_API_KEY=sk-kimi-your-api-key-here
   ```

### Using the Plugin

- **Analyze Current Function**: Press `Ctrl+Shift+K` in pseudocode view, or right-click → "KIMI: Analyze function"
- **Analyze All Functions**: Right-click in pseudocode view → "KIMI: Analyze all functions"
- **View Output**: Check IDA's Output window for `[KIMI]` prefixed messages

## Code Style Guidelines

### Rust Conventions

1. **Naming**: Mixed due to FFI bindings. Use `snake_case` for new Rust code; accept `non_camel_case_types` from bindgen.

2. **Safety**: Wrap all `unsafe` FFI calls in safe abstractions:
   ```rust
   // Good: Safe wrapper around unsafe FFI
   pub fn get_function_at(ea: ea_t) -> Option<&'static mut func_t> {
       unsafe { get_func(ea).as_mut() }
   }
   ```

3. **Error Handling**: Use `Option` and `Result` types; avoid panics in plugin code:
   ```rust
   let _ = std::panic::catch_unwind(|| {
       // plugin logic
   });
   ```

4. **Extension Traits**: Add methods to bindgen types via traits:
   ```rust
   pub trait FuncExt {
       fn start_ea(&self) -> ea_t;
       fn name(&self) -> String;
   }
   ```

### Unsafe Code Guidelines

1. **Static Mutables**: Minimize use; prefer `spin::Mutex` for synchronization
2. **FFI Boundaries**: Always validate pointers before dereferencing
3. **CString Lifetime**: Ensure C strings outlive FFI calls
4. **Thread Safety**: Use `execute_sync()` for IDA API calls from background threads

### Macros

Custom macros in `prelude.rs`:
- `println!(...)` - Outputs to IDA message window with `[KIMI]` prefix
- `dbg!(...)` - Debug output with file/line information

## Testing

### Manual Testing Checklist

1. **Plugin Load**: Verify "KIMI-IDA plugin loaded successfully" message
2. **Single Analysis**: Select a function, press Ctrl+Shift-K, verify renaming/comments applied
3. **Batch Analysis**: Test "Analyze all functions" on small binary
4. **Error Handling**: Test without API key, verify graceful error
5. **UI Integration**: Verify actions appear in right-click context menu

### Debugging

- Enable debug output: Use `dbg!(variable)` macro
- Check IDA Output window for `[KIMI]` messages
- Panics are caught and displayed in error dialog with file/line info

## Security Considerations

### API Key Management
- API key is read from `KIMI_API_KEY` environment variable only
- Never hardcode keys in source code
- Key is stored in memory during plugin lifetime

### Input Validation
- All AI responses are parsed as JSON before application
- Addresses are validated to be within function bounds before applying comments
- Function names are sanitized (falls back to "thunk" if starts with "sub_")

### Memory Safety
- Panic hook catches Rust panics before they reach IDA
- All FFI pointers are checked for null before dereferencing
- Use of `spin::Mutex` prevents data races in global state

## Known Limitations

1. **Platform**: Windows x64 only (relies on MSVC ABI)
2. **IDA Version**: Tested with IDA 9.0+ (EA64 mode). Struct layouts may need updates for other versions.
3. **Hex-Rays Version**: Hardcoded struct layouts (`cfunc_t`, `cinsn_t`) may mismatch with different Hex-Rays versions
4. **Memory Leaks**: Some qstring/qvector operations may leak memory (acceptable for short-lived plugin)

## Troubleshooting

### Build Errors

| Error | Solution |
|-------|----------|
| `IDA SDK not found` | Set `IDASDK` environment variable or ensure `ida-sdk/` submodule is cloned |
| `bindgen errors` | Check LLVM/Clang installation; verify IDA SDK headers are present |
| `linker errors` | Ensure `ida.lib` exists in project root |

### Runtime Issues

| Issue | Solution |
|-------|----------|
| Plugin doesn't load | Check IDA Output window for errors; verify API key is set |
| 403 Error from API | Verify API key; check model availability |
| Decompilation fails | Ensure Hex-Rays is installed and licensed |
| Comments not applied | Check function bounds validation; verify addresses in response |

## License

MIT License - See `LICENSE` file for details.

Copyright (c) 2026 Alex Mizumori
